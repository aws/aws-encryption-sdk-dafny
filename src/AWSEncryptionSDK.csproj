<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Library</OutputType>
    <TargetFramework>netcoreapp3.0</TargetFramework>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
  </PropertyGroup>

  <!--
    TODO: Temporary subset of files to build and verify.
    Add to this as more files can be verified.
    Eventually this can be a wildcard pattern.
  -->
  <ItemGroup>
    <DafnySource Include="Crypto/AESEncryption.dfy" />
    <DafnySource Include="Crypto/EncryptionSuites.dfy" />
    <DafnySource Include="Crypto/Digests.dfy" />
    <DafnySource Include="Crypto/HKDF/CryptoMac.dfy" />
    <DafnySource Include="Crypto/HKDF/HKDF.dfy" />
    <DafnySource Include="Crypto/HKDF/HKDFSpec.dfy" />
    <DafnySource Include="Crypto/Random.dfy" />
    <DafnySource Include="Crypto/RSAEncryption.dfy" />
    <DafnySource Include="Crypto/Signature.dfy" />
    <DafnySource Include="SDK/AlgorithmSuite.dfy" />
    <DafnySource Include="SDK/Client.dfy" />
    <DafnySource Include="SDK/CMM/DefaultCMM.dfy" />
    <DafnySource Include="SDK/CMM/Defs.dfy" />
    <DafnySource Include="SDK/Deserialize.dfy" />
    <DafnySource Include="SDK/Keyring/RawAESKeyring.dfy" />
    <DafnySource Include="SDK/Keyring/Defs.dfy" />
    <DafnySource Include="SDK/Keyring/MultiKeyring.dfy" />
    <DafnySource Include="SDK/Keyring/RawRSAKeyring.dfy" />
    <DafnySource Include="SDK/Materials.dfy" />
    <DafnySource Include="SDK/MessageBody.dfy" />
    <DafnySource Include="SDK/MessageHeader.dfy" />
    <DafnySource Include="SDK/Serialize.dfy" />
    <DafnySource Include="SDK/ToyClient.dfy" />
    <DafnySource Include="StandardLibrary/Base64.dfy" />
    <DafnySource Include="StandardLibrary/StandardLibrary.dfy" />
    <DafnySource Include="StandardLibrary/UInt.dfy" />
    <DafnySource Include="Util/Arrays.dfy" />
    <DafnySource Include="Util/Streams.dfy" />
    <DafnySource Include="Util/UTF8.dfy" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="Portable.BouncyCastle" Version="1.8.5.2" />
  </ItemGroup>
  
  <!-- TODO: extract generic Dafny tasks that can be shared as part of Dafny itself -->
  
  <Target Name="Verify" 
          Inputs="@(DafnySource)" 
          Outputs="@(DafnySource->'obj/Verification/%(Identity).verified')">
    <Message Text="Verifying %(DafnySource.Identity)..." Importance="high"/>
    <Exec Command="dafny %(DafnySource.Identity) /compile:0"/>
    <Exec Command="mkdir -p `dirname obj/Verification/%(DafnySource.Identity).verified`" />
    <Exec Command="touch obj/Verification/%(DafnySource.Identity).verified" />
  </Target>
  <Target Name="GenerateFromDafnySource" 
          AfterTargets="ResolveReferences"
          BeforeTargets="CoreCompile" 
          Inputs="$(MSBuildProjectFile);@(DafnySource)" 
          Outputs="../generated-src/Main.cs">
    <Exec Command="dafny /out:../generated-src/Main @(DafnySource, ' ') /compile:0 /spillTargetCode:3 /noVerify" />
    <ItemGroup>
      <Compile Include="../generated-src/Main.cs" />
    </ItemGroup>
  </Target>
</Project>
