<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Library</OutputType>
    <TargetFramework>netcoreapp3.0</TargetFramework>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <!-- 
    TODO: This is to avoid lots of warnings from the Dafny-generated code
    for things like unused variables and unreachable code. It's unfortunate
    that we then won't get these warnings for hand-written C# code either, though.
     -->
    <NoWarn>0164;0219;1717;0162;0168</NoWarn>
  </PropertyGroup>

  <!--
    TODO: Temporary subset of files to build and verify.
    Add to this as more files can be verified.
    Eventually this can be a wildcard pattern.
  -->
  <ItemGroup>
    <DafnySource Include="Crypto/AESEncryption.dfy" />
    <DafnySource Include="Crypto/EncryptionSuites.dfy" />
    <DafnySource Include="Crypto/Digests.dfy" />
    <DafnySource Include="Crypto/HKDF/CryptoMac.dfy" />
    <DafnySource Include="Crypto/HKDF/HKDF.dfy" />
    <DafnySource Include="Crypto/HKDF/HKDFSpec.dfy" />
    <DafnySource Include="Crypto/Random.dfy" />
    <DafnySource Include="Crypto/RSAEncryption.dfy" />
    <DafnySource Include="Crypto/Signature.dfy" />
    <DafnySource Include="SDK/AlgorithmSuite.dfy" />
    <DafnySource Include="SDK/Client.dfy" />
    <DafnySource Include="SDK/CMM/DefaultCMM.dfy" />
    <DafnySource Include="SDK/CMM/Defs.dfy" />
    <DafnySource Include="SDK/Deserialize.dfy" />
    <DafnySource Include="SDK/Keyring/RawAESKeyring.dfy" />
    <DafnySource Include="SDK/Keyring/Defs.dfy" />
    <DafnySource Include="SDK/Keyring/MultiKeyring.dfy" />
    <DafnySource Include="SDK/Keyring/RawRSAKeyring.dfy" />
    <DafnySource Include="SDK/Materials.dfy" />
    <DafnySource Include="SDK/MessageBody.dfy" />
    <DafnySource Include="SDK/MessageHeader.dfy" />
    <DafnySource Include="SDK/Serialize.dfy" />
    <DafnySource Include="SDK/ToyClient.dfy" />
    <DafnySource Include="StandardLibrary/Base64.dfy" />
    <DafnySource Include="StandardLibrary/StandardLibrary.dfy" />
    <DafnySource Include="StandardLibrary/UInt.dfy" />
    <DafnySource Include="Util/Arrays.dfy" />
    <DafnySource Include="Util/Streams.dfy" />
    <DafnySource Include="Util/UTF8.dfy" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="Portable.BouncyCastle" Version="1.8.5.2" />
  </ItemGroup>
  
  <!-- TODO: extract generic Dafny tasks that can be shared as part of Dafny itself -->
  
  <PropertyGroup>
    <Dafny Condition="'$(OS)' == 'Windows_NT'">Dafny.exe</Dafny>
    <Dafny Condition="'$(OS)' != 'Windows_NT'">dafny</Dafny>
  </PropertyGroup>

  <Target Name="Verify" 
          Inputs="@(DafnySource)" 
          Outputs="@(DafnySource->'obj/Verification/%(Identity).verified')">
    <Message Text="Verifying %(DafnySource.Identity)..." Importance="high"/>
    <Exec Command="$(Dafny) %(DafnySource.Identity) /compile:0"/>
    <Exec Command="mkdir -p `dirname obj/Verification/%(DafnySource.Identity).verified`" />
    <Exec Command="touch obj/Verification/%(DafnySource.Identity).verified" />
  </Target>

  <PropertyGroup>
    <DafnyOutputFile>../generated-src/Main.cs</DafnyOutputFile>
  </PropertyGroup>
  <Target Name="CompileDafny" 
          AfterTargets="ResolveReferences"
          BeforeTargets="CoreCompile" 
          Inputs="$(MSBuildProjectFile);@(DafnySource)" 
          Outputs="$(DafnyOutputFile)">
    <Message Text="Compiling Dafny source files to $(DafnyOutputFile)..." Importance="high"/>
    <Exec Command="$(Dafny) /out:$(DafnyOutputFile) @(DafnySource, ' ') /compile:0 /spillTargetCode:3 /noVerify" />
    <ItemGroup>
      <Compile Include="$(DafnyOutputFile)" />
    </ItemGroup>
  </Target>
  <!-- TODO: Define Inputs and Outputs for this -->
  <Target Name="CompileDafnyToJS">
    <Exec Command="$(Dafny) /out:build/Main @(DafnySource, ' ') /compile:2 /noVerify /noIncludes /compileTarget:js /spillTargetCode:1" />
  </Target>
</Project>
