version: 0.2

phases:
  install:
    commands:
      # Get .NET SDK 6.0 (for build tools only; projects specify their own toolchains)
      - Invoke-WebRequest https://dot.net/v1/dotnet-install.ps1 -UseBasicParsing -OutFile dotnet-install.ps1
      - ./dotnet-install.ps1 -Channel 6.0
      # Did CodeBuild let dotnet-install modify PATH?
      - echo $env:Path
      # Try preventing intermittent cert issue.
      # See <https://github.com/NuGet/Home/issues/11099> and
      # <https://github.com/NuGet/NuGet.Client/pull/4259#issue-7318389620>
      - set NUGET_EXPERIMENTAL_CHAIN_BUILD_RETRY_POLICY=3,1000
      # Get Dafny
      - Invoke-WebRequest https://github.com/dafny-lang/dafny/releases/download/v3.4.1/dafny-3.4.1-x64-win.zip -UseBasicParsing -OutFile dafny.zip
      - Expand-Archive -Path dafny.zip -DestinationPath .
      # We can't just add this to $env:Path because CodeBuild makes env vars read-only for some reason.
      # Assignment to $env:Path just silently fails.
      # So instead we copy the Dafny binary and DLLs to a known directory.
      - Copy-Item ".\dafny\*" -Destination "C:\codebuild\user\bin" -Recurse
      - Dafny.exe /version
  build:
    commands:
      - cd aws-encryption-sdk-net-formally-verified/Benchmarks
      - C:\Users\ContainerAdministrator\AppData\Local\Microsoft\dotnet\dotnet build -c Release

artifacts:
  files:
    - "aws-encryption-sdk-net-formally-verified/Benchmarks/BenchmarkDotNet.Artifacts/**/*"
