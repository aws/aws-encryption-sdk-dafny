version: 0.2

### NOTE ###
# There are intermittent cert verification failures during `dotnet restore`,
# which is run when acquiring dependencies for building .NET projects.

phases:
  install:
    commands:
      # Get Dafny
      - Invoke-WebRequest https://github.com/dafny-lang/dafny/releases/download/v3.4.1/dafny-3.4.1-x64-win.zip -UseBasicParsing -OutFile dafny.zip
      - Expand-Archive -Path dafny.zip -DestinationPath .
      # We can't just add this to $env:Path because CodeBuild makes env vars read-only for some reason.
      # Assignment to $env:Path just silently fails.
      # So instead we copy the Dafny binary and DLLs to a known directory.
      - Copy-Item ".\dafny\*" -Destination "C:\codebuild\user\bin" -Recurse
      - Dafny.exe /version
  build:
    commands:
      - cd aws-encryption-sdk-net-formally-verified/Test
      - |
        $originalErrorActionPreference = $ErrorActionPreference
        $ErrorActionPreference = "Stop"
        $attempts = 0
        while ($attempts -lt 5) {
          $attempts++
          try { dotnet restore 2>&1; break }
          catch { Write-Output $_; Start-Sleep -Seconds $attempts }
        }
        $ErrorActionPreference = $originalErrorActionPreference
      - dotnet test /nowarn:CS0105,CS0618
